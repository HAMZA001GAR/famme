<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Search Products - Famme</title>
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/web-awesome-ui@latest/web-awesome.css">
    <link rel="stylesheet" th:href="@{/css/product-search.css}">
</head>

<body>
    <div class="container">
        <a href="/products" class="back-link">
            ‚Üê Back to Products
        </a>

        <div class="header">
            <h1>üîç Search Products</h1>
            <p>Find products by title, vendor, type, or tags</p>
        </div>

        <div class="search-container">
            <div class="search-input-container">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" class="search-input"
                    placeholder="Search by title, vendor, type, or tags..." autocomplete="off" autofocus />
                <span class="search-loading" id="searchLoading">‚è≥</span>
            </div>

            <div class="search-stats" id="searchStats">
                <span id="resultCount">0</span> products found
            </div>

            <div class="search-suggestions" id="searchSuggestions">
                <span class="suggestion-tag" onclick="setSearchQuery('dress')">dress</span>
                <span class="suggestion-tag" onclick="setSearchQuery('shirt')">shirt</span>
                <span class="suggestion-tag" onclick="setSearchQuery('pants')">pants</span>
                <span class="suggestion-tag" onclick="setSearchQuery('accessories')">accessories</span>
                <span class="suggestion-tag" onclick="setSearchQuery('shoes')">shoes</span>
                <span class="suggestion-tag" onclick="setSearchQuery('bag')">bag</span>
            </div>
        </div>

        <div class="search-results" id="searchResults">
            <div class="no-results">
                <span class="no-results-icon">üì¶</span>
                <h3>Start Searching</h3>
                <p>Type in the search box above to find products</p>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div id="successMessage" class="success-message">
        <span id="successMessageText"></span>
    </div>

    <!-- Add this somewhere in your body -->
    <div id="confirmModal" class="wa-modal" style="display: none;">
        <div class="wa-modal-dialog">
            <div class="wa-modal-header">
                <h3 class="wa-modal-title">Confirm Delete</h3>
            </div>
            <div class="wa-modal-body">
                Are you sure you want to delete this product? This action cannot be undone.
            </div>
            <div class="wa-modal-footer">
                <button id="confirmYes" class="wa-button wa-danger">Yes, Delete</button>
                <button id="confirmCancel" class="wa-button wa-secondary">Cancel</button>
            </div>
        </div>
    </div>


    <script th:inline="javascript">
        let searchTimeout;
        let currentSearchQuery = ''; // Store current search query
        const searchInput = document.getElementById('searchInput');
        const searchLoading = document.getElementById('searchLoading');
        const searchStats = document.getElementById('searchStats');
        const resultCount = document.getElementById('resultCount');
        const searchResults = document.getElementById('searchResults');

        function setSearchQuery(query) {
            searchInput.value = query;
            performSearch(query);
        }

        function performSearch(query) {
            // Store current search query
            currentSearchQuery = query;

            // Show loading state
            searchLoading.classList.add('show');

            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            // Set new timeout for debouncing
            searchTimeout = setTimeout(() => {
                if (query.trim() === '') {
                    // Show initial state
                    searchResults.innerHTML = `
                        <div class="no-results">
                            <span class="no-results-icon">üì¶</span>
                            <h3>Start Searching</h3>
                            <p>Type in the search box above to find products</p>
                        </div>
                    `;
                    searchLoading.classList.remove('show');
                    resultCount.textContent = '0';
                    return;
                }

                // Perform search
                htmx.ajax('GET', `/products/search?query=${encodeURIComponent(query)}`, {
                    target: '#searchResults',
                    swap: 'innerHTML'
                }).then(() => {
                    searchLoading.classList.remove('show');
                    updateResultCount();
                }).catch(() => {
                    searchLoading.classList.remove('show');
                    searchResults.innerHTML = `
                        <div class="no-results">
                            <span class="no-results-icon">‚ùå</span>
                            <h3>Error</h3>
                            <p>Error loading results. Please try again.</p>
                        </div>
                    `;
                });
            }, 300); // 300ms debounce
        }

        function updateResultCount() {
            const rows = searchResults.querySelectorAll('tbody tr');
            const count = rows.length;
            resultCount.textContent = count;

            if (count === 0) {
                searchResults.innerHTML = `
                    <div class="no-results">
                        <span class="no-results-icon">üîç</span>
                        <h3>No Results Found</h3>
                        <p>No products match your search criteria. Try different keywords.</p>
                    </div>
                `;
            }
        }

        // Delete functionality
        async function deleteProduct(externalId) {
            const  confirmed = await showConfirmDialog();
            if(!confirmed) return;
            //if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
                // Use HTMX to delete the product
                htmx.ajax('DELETE', `/api/products/${externalId}`, {
                    swap: 'none'
                }).then(() => {
                    // Show success message
                    //showToast('Product deleted successfully!');
                    showSuccessMessage('Product deleted successfully!')
                    // Refresh the search results with current search query
                    const currentQuery = document.getElementById('searchInput').value;
                    performSearch(currentQuery);
                }).catch(error => {
                    console.error('Error deleting product:', error);
                    alert('Error deleting product. Please try again.');
                });
           //}
        }

        // Event listeners
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value;
            performSearch(query);
        });

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch(searchInput.value);
            }
        });

        // Focus search input on page load
        document.addEventListener('DOMContentLoaded', () => {
            searchInput.focus();
        });
        // function success message
        function showSuccessMessage(message) {
            const successElement = document.getElementById('successMessage');
            const messageText = document.getElementById('successMessageText');
            if (!successElement || !messageText) {
                console.error("Success message element missing from DOM");
                return;
            }
            messageText.textContent = message;
            successElement.classList.add('show');

            setTimeout(() => {
                successElement.classList.remove('show');
            }, 3000);
        }

        // Function to show confirm dialog and return a Promise
        function showConfirmDialog() {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmModal');
                const yesBtn = document.getElementById('confirmYes');
                const cancelBtn = document.getElementById('confirmCancel');

                modal.style.display = 'flex'; // show modal

                yesBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve(true);
                };

                cancelBtn.onclick = () => {
                    modal.style.display = 'none';
                    resolve(false);
                };
            });
        }

    </script>

</body>

</html>