
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">


<body>
    <div th:fragment="table">
        <div class="product-table-container">
            <div class="table-header">
                <h3>Products</h3>
                <div class="table-stats">
                    <span class="count" th:text="${#lists.size(products)}">0</span> products found
                    <span th:if="${searchQuery != null and searchQuery != ''}" th:text="${searchQuery}"></span>

                </div>
            </div>

            <div th:if="${#lists.isEmpty(products)}" class="no-products">
                <span class="no-products-icon">üì¶</span>
                <h4>No products found</h4>
                <p th:if="${searchQuery != null and searchQuery != ''}">
                    No products match your search for "<span th:text="${searchQuery}"></span>"
                </p>
                <p th:unless="${searchQuery != null and searchQuery != ''}">
                    No products available. Click "Sync Products" to fetch products from the external API.
                </p>
            </div>

            <table th:if="${!#lists.isEmpty(products)}" class="wa-table wa-striped wa-hover">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Vendor</th>
                        <th>Type</th>
                        <th>Tags</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="product : ${products}">
                        <td>
                            <div class="product-title" th:text="${product.title}"></div>
                        </td>
                        <td>
                            <div class="product-vendor" th:text="${product.vendor ?: 'N/A'}"></div>
                        </td>
                        <td>
                            <span th:if="${product.productType != null}" class="product-type"
                                th:text="${product.productType}"></span>
                            <span th:unless="${product.productType != null}" class="product-vendor">N/A</span>
                        </td>
                        <td>
                            <div class="product-tags" th:if="${product.tags != null and #lists.size(product.tags) > 0}">
                                <span th:each="tag : ${product.tags}" class="tag" th:text="${tag}"></span>
                            </div>
                            <span th:unless="${product.tags != null and #lists.size(product.tags) > 0}"
                                class="product-vendor">No tags</span>
                        </td>
                        <td>
                            <div class="product-date" th:if="${product.createdAt != null}"
                                th:text="${#strings.substring(product.createdAt.toString(), 0, 10)}"></div>
                            <div th:unless="${product.createdAt != null}" class="product-vendor">N/A</div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a th:href="@{/products/update/{id}(id=${product.externalId})}"
                                    class="wa-button wa-primary wa-small">
                                    ‚úèÔ∏è Update
                                </a>
                                <button type="button" class="wa-button wa-danger wa-small"
                                    th:data-product-id="${product.externalId}" th:data-product-title="${product.title}"
                                    onclick="deleteProduct(this.dataset.productId)"
                                    th:title="'Delete ' + ${product.title}" aria-label="Delete product">
                                    ‚ö†Ô∏è Delete
                                </button>

                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div id="deleteConfirmationDialog" class="modal">
        <div class="modal-content">
            <h2>Confirm Deletion</h2>
            <p>Are you sure you want to delete the product "<span id="productTitleToDelete"></span>"?</p>
            <button id="confirmDeleteBtn" class="wa-button wa-danger">Confirm Delete</button>
            <button class="wa-button wa-secondary" onclick="hideDeleteConfirmation()">Cancel</button>
        </div>
    </div>
    <div id="successMessage" class="modal">
        <div class="modal-content">
            <p id="successMessageText"></p>
            <button class="wa-button wa-primary" onclick="hideSuccessMessage()">OK</button>
        </div>
    </div>
    <script>
        let productToDelete = null;
        let isDeleting = false;

        function showDeleteConfirmation(externalId, productTitle) {
            if (isDeleting) {
                return; // Prevent multiple delete operations
            }
            productToDelete = externalId;
            document.getElementById('productTitleToDelete').textContent = productTitle;
            document.getElementById('deleteConfirmationDialog').classList.add('show');
        }

        function hideDeleteConfirmation() {
            document.getElementById('deleteConfirmationDialog').classList.remove('show');
            productToDelete = null;
        }

        function showSuccessMessage(message) {
            const successElement = document.getElementById('successMessage');
            const messageText = document.getElementById('successMessageText');
            messageText.textContent = message;
            successElement.classList.add('show');

            // Auto-hide after 3 seconds
            setTimeout(() => {
                successElement.classList.remove('show');
            }, 3000);
        }

        function hideSuccessMessage() {
            const successElement = document.getElementById('successMessage');
            successElement.classList.remove('show');
        }

        function deleteProduct(externalId) {
            if (productToDelete && !isDeleting) {
                isDeleting = true;
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                const originalText = confirmBtn.textContent;

                // Show loading state
                confirmBtn.classList.add('loading');
                confirmBtn.textContent = 'Deleting...';
                confirmBtn.disabled = true;

                // Use HTMX to delete the product
                htmx.ajax('DELETE', `/api/products/${externalId}`, {
                    target: '#product-table',
                    swap: 'innerHTML',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then((response) => {
                    // Check if deletion was successful
                    if (response.status >= 200 && response.status < 300) {
                        // Reload the product table after successful deletion
                        htmx.ajax('GET', '/products/load', {
                            target: '#product-table',
                            swap: 'innerHTML'
                        });

                        // Show success message
                        showSuccessMessage('Product deleted successfully!');

                        hideDeleteConfirmation();
                    } else {
                        throw new Error('Failed to delete product');
                    }
                }).catch(error => {
                    console.error('Error deleting product:', error);
                    let errorMessage = 'Error deleting product. Please try again.';

                    // Try to extract error message from response
                    if (error.response && error.response.body) {
                        try {
                            const errorData = JSON.parse(error.response.body);
                            if (errorData.message) {
                                errorMessage = errorData.message;
                            }
                        } catch (e) {
                            // If we can't parse JSON, use the raw response
                            if (typeof error.response.body === 'string') {
                                errorMessage = error.response.body;
                            }
                        }
                    }

                    alert(errorMessage);
                    hideDeleteConfirmation();
                }).finally(() => {
                    // Reset button state
                    confirmBtn.classList.remove('loading');
                    confirmBtn.textContent = originalText;
                    confirmBtn.disabled = false;
                    isDeleting = false;
                });
            }
        }

        // Set up the confirm delete button
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('confirmDeleteBtn').addEventListener('click', deleteProduct);
        });

        // Close dialog when clicking outside
        document.getElementById('deleteConfirmationDialog').addEventListener('click', function (e) {
            if (e.target === this) {
                hideDeleteConfirmation();
            }
        });

        // Keyboard support
        document.addEventListener('keydown', function (e) {
            if (document.getElementById('deleteConfirmationDialog').classList.contains('show')) {
                if (e.key === 'Escape') {
                    hideDeleteConfirmation();
                } else if (e.key === 'Enter' && !isDeleting) {
                    deleteProduct();
                }
            }
        });
    </script>
</body>

</html>
